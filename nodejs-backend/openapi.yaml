openapi: 3.0.3
info:
  title: Guider Backend API
  version: 2.0.0
  description: >
    API documentation.

servers:
  - url: http://localhost:3000
    description: Local development server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  # ==========================
  # Reusable Responses (FIXED)
  # ==========================
  responses:
    BadRequest:
      description: Bad request / validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/OkFalseResponse"

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/OkFalseResponse"

    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/OkFalseResponse"

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/OkFalseResponse"

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/OkFalseResponse"

  schemas:
    AuthRequest:
      type: object
      required:
        - login
        - password
      properties:
        token:
          type: string
          nullable: true
          description: Optional field, currently not used on backend side.
        login:
          type: string
          example: testuser
        password:
          type: string
          example: "1234"

    AuthResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        token:
          type: string
          nullable: true
          description: JWT token if operation is successful.
        message:
          type: string
          nullable: true
          description: Error message if ok is false.

    ErrorResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: false
        message:
          type: string
          example: "Something went wrong"
        new_id:
          type: integer
          nullable: true
        item_id:
          type: integer
          nullable: true
        collection_id:
          type: integer
          nullable: true

    OkFalseResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: false
        message:
          type: string
          example: "Internal server error"
      required: [ok, message]

    CollectionItem:
      type: object
      properties:
        id:
          type: integer
          example: 1
        collectionId:
          type: integer
          example: 1
        urlImage:
          type: string
          nullable: true
          example: "https://example.com/item-preview.png"
        imagePath:
          type: string
          nullable: true
          example: "/uploads/items/item-1700000000000.png"
        description:
          type: string
          nullable: true
          example: "Item description"

    CollectionFull:
      type: object
      properties:
        id:
          type: integer
          example: 3
        ownerId:
          type: integer
          example: 1
        urlImage:
          type: string
          nullable: true
        imagePath:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
          example: "My first collection from draft"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: "#/components/schemas/CollectionItem"

    DraftConstructorResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        new_id:
          type: integer
          example: 1

    ConstructorMetaRequest:
      type: object
      properties:
        url_image:
          type: string
          nullable: true
          example: "https://example.com/collection-header.png"
        image:
          type: string
          nullable: true
          description: Local server image path returned by /upload/collection-image.
          example: "/uploads/collections/col-1700000000000.png"
        description:
          type: string
          nullable: true
          example: "My first collection"

    CreateItemRequest:
      type: object
      required:
        - description
      properties:
        item_id:
          type: integer
          nullable: true
          description: Desired item id from client. Backend may adjust it if invalid.
        url_image:
          type: string
          nullable: true
          example: "https://example.com/item-preview.png"
        image:
          type: string
          nullable: true
          description: Local server image path returned by /upload/item-image.
          example: "/uploads/items/item-1700000000000.png"
        description:
          type: string
          example: "Item description"
        next:
          type: boolean
          description: If true, user wants to create another item.
          example: true
        save_exit:
          type: boolean
          description: If true, finalize collection and stop constructor.
          example: false

    CreateItemContinueResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        new_id:
          type: integer
          example: 1
        item_id:
          type: integer
          example: 2

    CreateItemFinalizeResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        collection_id:
          type: integer
          example: 1

    UploadImageResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        imagePath:
          type: string
          example: "/uploads/collections/col-1700000000000.png"

    DrawingTopicResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        topic:
          type: string
          nullable: true
          example: "Draw a flying cat in the city"
        message:
          type: string
          nullable: true
          example: "No topics available"

    # ==========================
    # Home schemas
    # ==========================
    HomeItem:
      type: object
      properties:
        item_id:
          type: integer
          example: 10
        url_image:
          type: string
          nullable: true
          example: "https://example.com/item.png"
        description:
          type: string
          nullable: true
          example: "Item description"
      required: [item_id, url_image, description]

    CollectionType:
      type: string
      enum:
        - WALK_AROUND_CITY
        - DATE
        - DINNER
        - MOVIE_NIGHT
        - COFFEE_TALK
        - TRAVEL
        - MUSEUM
        - SPORTS
        - PARTY
        - DEFAULT

    HomeCollection:
      type: object
      properties:
        id:
          type: integer
          example: 1
        url_image:
          type: string
          nullable: true
          example: "https://example.com/collection.png"
        type:
          $ref: "#/components/schemas/CollectionType"
        description:
          type: string
          nullable: true
          example: "Collection description"
        items:
          type: array
          items:
            $ref: "#/components/schemas/HomeItem"
      required: [id, url_image, type, description, items]

    HomeCollectionsResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        collections:
          type: array
          items:
            $ref: "#/components/schemas/HomeCollection"
      required: [ok, collections]

    SearchRoomRequest:
      type: object
      properties:
        id:
          type: integer
          minimum: 1
          example: 1
      required: [id]

    SearchRoomResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        id_room:
          type: integer
          example: 1
      required: [ok, id_room]

    # ==========================
    # Drawing points (FIXED)
    # ==========================
    DrawingPoint:
      type: object
      required: [x, y]
      properties:
        x:
          type: number
          example: 120.5
        y:
          type: number
          example: 42.2
        color:
          type: string
          nullable: true
          example: "#000000"

    DrawingPoints:
      type: array
      items:
        $ref: "#/components/schemas/DrawingPoint"

paths:
  /auth/register:
    post:
      summary: Register a new user
      description: Create a new user and return a JWT token.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRequest"
      responses:
        "200":
          description: Register result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"

  /auth/login:
    post:
      summary: Login
      description: Authenticate user and return a JWT token.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRequest"
      responses:
        "200":
          description: Login result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"

  /collections/constructor:
    post:
      summary: Create or get draft collection
      tags: [Collections]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Draft collection id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DraftConstructorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /collections/constructor/{new_id}:
    post:
      summary: Save or load draft collection constructor state
      tags: [Collections]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: new_id
          required: true
          schema:
            type: integer
          description: Draft collection id (may be ignored on server side)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConstructorMetaRequest"
      responses:
        "200":
          description: Draft metadata saved or state loaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  new_id:
                    type: integer
                  item_id:
                    type: integer
                    nullable: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /collections/constructor/item:
    post:
      summary: Create item in draft collection (or finalize)
      tags: [Collections]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateItemRequest"
      responses:
        "200":
          description: Item created or collection finalized
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/CreateItemContinueResponse"
                  - $ref: "#/components/schemas/CreateItemFinalizeResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /collections/{id}:
    get:
      summary: Get collection (private)
      tags: [Collections]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Collection data
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  collection:
                    $ref: "#/components/schemas/CollectionFull"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

    put:
      summary: Update collection (private)
      tags: [Collections]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url_image:
                  type: string
                  nullable: true
                image:
                  type: string
                  nullable: true
                description:
                  type: string
                  nullable: true
      responses:
        "200":
          description: Updated collection
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  collection:
                    $ref: "#/components/schemas/CollectionFull"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /upload/collection-image:
    post:
      summary: Upload collection image
      tags: [Upload]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
      responses:
        "200":
          description: Upload result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadImageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  /upload/item-image:
    post:
      summary: Upload item image
      tags: [Upload]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
      responses:
        "200":
          description: Upload result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadImageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  /drawing/topic:
    get:
      summary: Get a drawing topic
      tags: [Drawing]
      parameters:
        - in: query
          name: last_topic
          schema:
            type: string
            nullable: true
          required: false
      responses:
        "200":
          description: Drawing topic response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DrawingTopicResponse"
        "500":
          $ref: "#/components/responses/ServerError"

  /home:
    get:
      tags: [Home]
      summary: Get ready collections for Home (public)
      responses:
        "200":
          description: Collections list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HomeCollectionsResponse"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      tags: [Home]
      summary: Get collections of current user (private)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User collections list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HomeCollectionsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /home/search:
    post:
      tags: [Home]
      summary: Search room by id (private)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchRoomRequest"
      responses:
        "200":
          description: Room found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchRoomResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /rooms/create:
    post:
      tags: [Rooms]
      summary: Create room or check access
      description: |
        Mode 1 (empty body): check access  
        Mode 2: create a new room
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                type_match:
                  type: integer
                  enum: [1, 2]
                password:
                  type: string
                type_collections:
                  type: integer
                  enum: [1, 2]
                collection_id:
                  oneOf:
                    - type: integer
                    - type: array
                      items:
                        type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
                      id_room:
                        type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /rooms/connect/{id_room}:
    post:
      tags: [Rooms]
      summary: Connect to room or get collections
      description: |
        Mode 1 (empty body): return user's collections  
        Mode 2: submit password + collection_id
      security:
        - bearerAuth: []
      parameters:
        - name: id_room
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
                collection_id:
                  type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
                      collection_choose:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                            type:
                              type: string
                            url_image:
                              type: string
                              nullable: true
                            description:
                              type: string
                              nullable: true
                            title:
                              type: string
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /rooms/{id_room}:
    post:
      tags: [Rooms]
      summary: Room cards flow
      description: |
        Mode 1 (empty body): get current card  
        Mode 2: submit choice (0 exit, 1 yes, 2 no)
      security:
        - bearerAuth: []
      parameters:
        - name: id_room
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                choose:
                  type: integer
                  enum: [0, 1, 2]
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
                      nick:
                        type: string
                      profile_picture_url:
                        type: string
                        nullable: true
                      name_card:
                        type: string
                      description:
                        type: string
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
                      redirect:
                        type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /rooms/{id_room}/drawing:
    post:
      tags: [Rooms]
      summary: Drawing page
      description: |
        Mode 1 (empty body): get topic and existing points  
        Mode 2: submit full points list
      security:
        - bearerAuth: []
      parameters:
        - name: id_room
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                points:
                  $ref: "#/components/schemas/DrawingPoints"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
                      topic:
                        type: string
                        nullable: true
                      points:
                        $ref: "#/components/schemas/DrawingPoints"
                  - type: object
                    properties:
                      ok:
                        type: boolean
                        example: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /rooms/{id_room}/results:
    post:
      tags: [Results]
      summary: Room results
      description: Return selected cards for all users
      security:
        - bearerAuth: []
      parameters:
        - name: id_room
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
                  cards:
                    type: array
                    items:
                      type: object
                      properties:
                        profile_picture_url:
                          type: string
                          nullable: true
                        name_card:
                          type: string
                        description:
                          type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
